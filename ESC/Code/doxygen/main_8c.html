<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Sensorless control of 3-phase brushless DC motors: main.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>main.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
Atmel Corporation<p>
<ul>
<li>File : <a class="el" href="main_8c.html">main.c</a></li><li>Compiler : IAR EWAAVR 2.28a/3.10c</li></ul>
<p>
<ul>
<li>Support mail : <a href="mailto:avr@atmel.com">avr@atmel.com</a></li></ul>
<p>
<ul>
<li>Supported devices : ATmega48/88/168</li></ul>
<p>
<ul>
<li>AppNote : AVR444 - Sensorless control of three-phase brushless DC motors with ATmega48.</li></ul>
<p>
<ul>
<li>Description : Example of how to use the ATmega48 for sensorless control of a three phase brushless DC motor.</li></ul>
<p>
<dl compact><dt><b>Revision</b></dt><dd>1.1 </dd></dl>
<dl compact><dt><b>Date</b></dt><dd>Monday, October 10, 2005 11:15:46 UTC </dd></dl>

<p>
Definition in file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
<code>#include &quot;<a class="el" href="BLDC_8h-source.html">BLDC.h</a>&quot;</code><br>
<code>#include &lt;ioavr.h&gt;</code><br>
<code>#include &lt;inavr.h&gt;</code><br>

<p>
Include dependency graph for main.c:<p><center><img src="main_8c__incl.png" border="0" usemap="#main.c_map" alt=""></center>
<map name="main.c_map">
<area href="BLDC_8h.html" shape="rect" coords="119,7,188,33" alt="">
</map>

<p>
<a href="main_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a31">CalculateCurrent</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculates current consumption.  <a href="#a31"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static unsigned long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a29">CalculateSpeed</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculates the current speed in electrical RPM.  <a href="#a29"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static unsigned long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a30">CalculateSpeedSetpoint</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculates the speed set-point in electrical RPM.  <a href="#a30"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a22">Commutate</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Commutates and prepares for new zero-cross detection.  <a href="#a22"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a33">CurrentControl</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Current control loop.  <a href="#a33"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a24">CurrentMeasurementComplete</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a23">EnableZCDetection</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Enables zero-cross detection.  <a href="#a23"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a16">InitADC</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the AD-converter.  <a href="#a16"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a17">InitAnalogComparator</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the analog comparator.  <a href="#a17"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a14">InitPorts</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes I/O ports.  <a href="#a14"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a15">InitTimers</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes timers (for commutation timing and PWM).  <a href="#a15"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a12">main</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Program entry point.  <a href="#a12"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a19">MakeTables</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes arrays for motor driving and AD channel selection.  <a href="#a19"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a21">MotorPWMBottom</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Timer/counter0 bottom overflow. Used for zero-cross detection.  <a href="#a21"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a26">OverCurrentISR</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Overcurrent interrupt.  <a href="#a26"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a28">PWMControl</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a13">ResetHandler</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Examines the reset source and acts accordingly.  <a href="#a13"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static signed int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a32">SpeedControl</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Speed control loop.  <a href="#a32"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a20">StartMotor</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Executes the motor startup sequence.  <a href="#a20"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a27">StartupDelay</a> (unsigned int delay)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generates a delay used during startup.  <a href="#a27"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a25">WatchdogISR</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Watchdog interrupt.  <a href="#a25"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a18">WatchdogTimerEnable</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the watchdog timer.  <a href="#a18"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a1">ADMUXTable</a> [6]</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Array of ADC channel selections for each commutation step.  <a href="#a1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a11">currentUpdated</a> = FALSE</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Flag that specifies whether a new current measurement is available.  <a href="#a11"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a0">driveTable</a> [6]</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Array of power stage enable signals for each commutation step.  <a href="#a0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__regvar __no_init volatile <br>
unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a3">filteredTimeSinceCommutation</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Filtered commutation timer variable and speed indicator. This value equals half the time of one commutation step. It is filtered through an IIR filter, so the value stored is not the most recent measuremnt. The variable is stored in registers R14-R15 for quicker access.  <a href="#a3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__regvar __no_init volatile <br>
unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a6">nextCommutationStep</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The commutation step that starts at next commutation.  <a href="#a6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__regvar __no_init volatile <br>
unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a4">nextDrivePattern</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The power stage enable signals that will be output to the motor drivers at next commutation.  <a href="#a4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a9">referenceVoltageADC</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">ADC reading of the known external reference voltage.  <a href="#a9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a8">shuntVoltageADC</a> = 0</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">ADC reading of shunt voltage.  <a href="#a8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a7">speedReferenceADC</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">ADC reading of external analog speed reference.  <a href="#a7"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a10">speedUpdated</a> = FALSE</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Flag that specifies whether a new external speed reference and a motor speed measurement is available.  <a href="#a10"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a2">startupDelays</a> [STARTUP_NUM_COMMUTATIONS]</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Array holding the intercommutation delays used during startup.  <a href="#a2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__regvar __no_init volatile <br>
unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a5">zcPolarity</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Polarity of the expected zero crossing.  <a href="#a5"></a><br></td></tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a31"></a><!-- doxytag: member="main.c::CalculateCurrent" ref="a31" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static unsigned int CalculateCurrent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Calculates current consumption. 
<p>
This function calculates the current consumption in milliAmperes from the global variable <a class="el" href="main_8c.html#a8">shuntVoltageADC</a>. The external know reference voltage is used to compensate for varying AREF voltage.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00719">719</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00228">EXTERNAL_REF_VOLTAGE</a>, <a class="el" href="main_8c-source.html#l00074">referenceVoltageADC</a>, <a class="el" href="BLDC_8h-source.html#l00231">SHUNT_RESISTANCE</a>, <a class="el" href="main_8c-source.html#l00071">shuntVoltageADC</a>, and <a class="el" href="BLDC_8h-source.html#l00042">UL</a>.<div class="fragment"><pre class="fragment"><a name="l00720"></a>00720 {
<a name="l00721"></a>00721   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ADCref;
<a name="l00722"></a>00722   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> current;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724   <span class="comment">// Calculate the voltage at AREF pin (scaled down motor supply voltage),</span>
<a name="l00725"></a>00725   <span class="comment">// using the known reference voltage. (In milliVolts)</span>
<a name="l00726"></a>00726   ADCref = <a class="code" href="BLDC_8h.html#a64">EXTERNAL_REF_VOLTAGE</a> * 256<a class="code" href="BLDC_8h.html#a5">UL</a> / <a class="code" href="main_8c.html#a9">referenceVoltageADC</a>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <span class="comment">// Calculate the current through the shunt. (In milliAmperes)</span>
<a name="l00729"></a>00729   current = (<span class="keywordtype">unsigned</span> int)((<a class="code" href="main_8c.html#a8">shuntVoltageADC</a> * ADCref * 1000<a class="code" href="BLDC_8h.html#a5">UL</a> / 256<a class="code" href="BLDC_8h.html#a5">UL</a>) / <a class="code" href="BLDC_8h.html#a65">SHUNT_RESISTANCE</a>);
<a name="l00730"></a>00730 
<a name="l00731"></a>00731   <span class="keywordflow">return</span> current;
<a name="l00732"></a>00732 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a29"></a><!-- doxytag: member="main.c::CalculateSpeed" ref="a29" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static unsigned long CalculateSpeed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Calculates the current speed in electrical RPM. 
<p>
This function calculates the current speed in electrical rotations per minute from the global variable <a class="el" href="main_8c.html#a3">filteredTimeSinceCommutation</a>.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00672">672</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="main_8c-source.html#l00042">filteredTimeSinceCommutation</a>, and <a class="el" href="BLDC_8h-source.html#l00243">TICKS_PER_MINUTE</a>.<div class="fragment"><pre class="fragment"><a name="l00673"></a>00673 {
<a name="l00674"></a>00674   <span class="comment">// Copy used to minimize period where interrupts are disabled.</span>
<a name="l00675"></a>00675   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> filteredTimeSinceCommutationCopy;
<a name="l00676"></a>00676   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rotationPeriod;
<a name="l00677"></a>00677   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> speed;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   <span class="comment">/*</span>
<a name="l00680"></a>00680 <span class="comment">  Disable interrupts to ensure that \ref filteredTimeSinceCommutation is accessed in</span>
<a name="l00681"></a>00681 <span class="comment">  an atomic operation.</span>
<a name="l00682"></a>00682 <span class="comment">  */</span>
<a name="l00683"></a>00683   __disable_interrupt();
<a name="l00684"></a>00684   filteredTimeSinceCommutationCopy = <a class="code" href="main_8c.html#a3">filteredTimeSinceCommutation</a>;
<a name="l00685"></a>00685   __enable_interrupt();
<a name="l00686"></a>00686 
<a name="l00687"></a>00687   <span class="comment">/*</span>
<a name="l00688"></a>00688 <span class="comment">  filteredTimeSinceCommutation is one half commutation time. Must be multiplied by 12 to get</span>
<a name="l00689"></a>00689 <span class="comment">  one full rotation.</span>
<a name="l00690"></a>00690 <span class="comment">  */</span>
<a name="l00691"></a>00691   rotationPeriod = (<span class="keywordtype">unsigned</span> long)filteredTimeSinceCommutationCopy * 12;
<a name="l00692"></a>00692   speed = (<a class="code" href="BLDC_8h.html#a68">TICKS_PER_MINUTE</a> / rotationPeriod);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694   <span class="keywordflow">return</span> speed;
<a name="l00695"></a>00695 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a30"></a><!-- doxytag: member="main.c::CalculateSpeedSetpoint" ref="a30" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static unsigned long CalculateSpeedSetpoint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Calculates the speed set-point in electrical RPM. 
<p>
This function calculates the speed set-point from the global variable speedReferenceADC.<p>
In this implementation, the speed reference values from 0x00 to 0xff are linearly mapped into the allowable speed range, set by <a class="el" href="BLDC_8h.html#a82">MIN_SPEED</a> and <a class="el" href="BLDC_8h.html#a83">MAX_SPEED</a>.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00707">707</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00234">ADC_RESOLUTION</a>, <a class="el" href="BLDC_8h-source.html#l00308">MAX_SPEED</a>, <a class="el" href="BLDC_8h-source.html#l00305">MIN_SPEED</a>, and <a class="el" href="main_8c-source.html#l00068">speedReferenceADC</a>.<div class="fragment"><pre class="fragment"><a name="l00708"></a>00708 {
<a name="l00709"></a>00709   <span class="keywordflow">return</span> (<a class="code" href="BLDC_8h.html#a82">MIN_SPEED</a> + ((<a class="code" href="BLDC_8h.html#a83">MAX_SPEED</a> - <a class="code" href="BLDC_8h.html#a82">MIN_SPEED</a>) * (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="main_8c.html#a7">speedReferenceADC</a>) / <a class="code" href="BLDC_8h.html#a66">ADC_RESOLUTION</a>);
<a name="l00710"></a>00710 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a22"></a><!-- doxytag: member="main.c::Commutate" ref="a22" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__interrupt void Commutate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Commutates and prepares for new zero-cross detection. 
<p>
This interrupt service routine is triggered exactly when a commutation is scheduled. The commutation is performed instantly and Timer/counter0 is reset to measure the delay between commutation and zero-cross detection.<p>
Commutation causes large transients on all phases for a short while that could cause false zero-cross detections. A zero cross detection hold-off period is therefore used to avoid any false readings. This is performed by using Timer/counter1 compare B. The compare is set to happen after the specified hold-off period. Timer/counter1 compare B interrupt handler then enables the zero-cross detection.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00482">482</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00216">CLEAR_ALL_TIMER1_INT_FLAGS</a>, <a class="el" href="BLDC_8h-source.html#l00114">DRIVE_PORT</a>, <a class="el" href="main_8c-source.html#l00065">nextCommutationStep</a>, <a class="el" href="main_8c-source.html#l00050">nextDrivePattern</a>, <a class="el" href="BLDC_8h-source.html#l00225">SET_TIMER1_INT_HOLDOFF</a>, <a class="el" href="BLDC_8h-source.html#l00201">ZC_DETECTION_HOLDOFF_TIME_US</a>, and <a class="el" href="main_8c-source.html#l00057">zcPolarity</a>.<div class="fragment"><pre class="fragment"><a name="l00483"></a>00483 {
<a name="l00484"></a>00484   <span class="comment">// Commutate and clear commutation timer.</span>
<a name="l00485"></a>00485   <a class="code" href="BLDC_8h.html#a28">DRIVE_PORT</a> = <a class="code" href="main_8c.html#a4">nextDrivePattern</a>;
<a name="l00486"></a>00486   TCNT1 = 0;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   <a class="code" href="main_8c.html#a5">zcPolarity</a> = <a class="code" href="main_8c.html#a6">nextCommutationStep</a> &amp; 0x01;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490   <span class="comment">// Set zero-cross detection holdoff time.</span>
<a name="l00491"></a>00491   <a class="code" href="BLDC_8h.html#a60">CLEAR_ALL_TIMER1_INT_FLAGS</a>;
<a name="l00492"></a>00492   OCR1B = <a class="code" href="BLDC_8h.html#a55">ZC_DETECTION_HOLDOFF_TIME_US</a>;
<a name="l00493"></a>00493   <a class="code" href="BLDC_8h.html#a63">SET_TIMER1_INT_HOLDOFF</a>;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   __watchdog_reset();
<a name="l00496"></a>00496 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a33"></a><!-- doxytag: member="main.c::CurrentControl" ref="a33" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static unsigned char CurrentControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Current control loop. 
<p>
This function is called after the speed control loop. The desired duty cycle calculated by the speed control loop is available, and this function is responsible for adjusting the duty cycle to ensure that the current stays within limits.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00767">767</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h.html#a98">CalculateCurrent()</a>, <a class="el" href="BLDC_8h-source.html#l00269">CURRENT_LIMITER_CRITICAL</a>, <a class="el" href="BLDC_8h-source.html#l00281">CURRENT_LIMITER_FACTOR</a>, <a class="el" href="BLDC_8h-source.html#l00266">CURRENT_LIMITER_START</a>, and <a class="el" href="BLDC_8h-source.html#l00114">DRIVE_PORT</a>.<div class="fragment"><pre class="fragment"><a name="l00768"></a>00768 {
<a name="l00769"></a>00769   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> current;
<a name="l00770"></a>00770   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> overCurrentCorrection = 0;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772   current = <a class="code" href="BLDC_8h.html#a98">CalculateCurrent</a>();
<a name="l00773"></a>00773 
<a name="l00774"></a>00774   <span class="comment">// Cut power to motor if current is critically high.</span>
<a name="l00775"></a>00775   <span class="keywordflow">if</span> (current &gt; <a class="code" href="BLDC_8h.html#a73">CURRENT_LIMITER_CRITICAL</a>)
<a name="l00776"></a>00776   {
<a name="l00777"></a>00777     <a class="code" href="BLDC_8h.html#a28">DRIVE_PORT</a> = 0x00;
<a name="l00778"></a>00778     <span class="keywordflow">for</span> (;;)
<a name="l00779"></a>00779     {
<a name="l00780"></a>00780       <span class="comment">// Stop and let watchdog timer reset part.</span>
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782   }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784   <span class="keywordflow">if</span> (current &gt; <a class="code" href="BLDC_8h.html#a72">CURRENT_LIMITER_START</a>)
<a name="l00785"></a>00785   {
<a name="l00786"></a>00786     overCurrentCorrection = (current - <a class="code" href="BLDC_8h.html#a72">CURRENT_LIMITER_START</a>) * <a class="code" href="BLDC_8h.html#a75">CURRENT_LIMITER_FACTOR</a>;
<a name="l00787"></a>00787   }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789   <span class="keywordflow">if</span> (overCurrentCorrection &gt; 255)
<a name="l00790"></a>00790   {
<a name="l00791"></a>00791     <span class="keywordflow">return</span> 255;
<a name="l00792"></a>00792   }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794   <span class="keywordflow">return</span> overCurrentCorrection;
<a name="l00795"></a>00795 }
</pre></div>
<p>

<p>
Here is the call graph for this function:<p><center><img src="main_8c_a33_cgraph.png" border="0" usemap="#main_8c_a33_cgraph_map" alt=""></center>
<map name="main_8c_a33_cgraph_map">
<area href="BLDC_8h.html#a98" shape="rect" coords="164,7,287,33" alt="">
</map>
    </td>
  </tr>
</table>
<a class="anchor" name="a24"></a><!-- doxytag: member="main.c::CurrentMeasurementComplete" ref="a24" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__interrupt void CurrentMeasurementComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00544">544</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00207">CLEAR_ALL_TIMER0_INT_FLAGS</a>, <a class="el" href="main_8c-source.html#l00080">currentUpdated</a>, <a class="el" href="main_8c-source.html#l00071">shuntVoltageADC</a>, and <a class="el" href="BLDC_8h-source.html#l00039">TRUE</a>.<div class="fragment"><pre class="fragment"><a name="l00545"></a>00545 {
<a name="l00546"></a>00546   <a class="code" href="main_8c.html#a8">shuntVoltageADC</a> = ADCH;
<a name="l00547"></a>00547   <a class="code" href="main_8c.html#a11">currentUpdated</a> = <a class="code" href="BLDC_8h.html#a4">TRUE</a>;
<a name="l00548"></a>00548   <a class="code" href="BLDC_8h.html#a57">CLEAR_ALL_TIMER0_INT_FLAGS</a>;
<a name="l00549"></a>00549 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a23"></a><!-- doxytag: member="main.c::EnableZCDetection" ref="a23" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__interrupt void EnableZCDetection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Enables zero-cross detection. 
<p>
This interrupt service routine is triggered when the zero cross detection hold-off time after commutation is over. All Timer/counter1 interrupts are disabled and Timer/counter0 (PWM) overflow interrupt is enabled to allow the ADC readings to be used for zero-cross detection.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00507">507</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="main_8c-source.html#l00032">ADMUXTable</a>, <a class="el" href="BLDC_8h-source.html#l00207">CLEAR_ALL_TIMER0_INT_FLAGS</a>, <a class="el" href="BLDC_8h-source.html#l00216">CLEAR_ALL_TIMER1_INT_FLAGS</a>, <a class="el" href="BLDC_8h-source.html#l00219">DISABLE_ALL_TIMER1_INTS</a>, <a class="el" href="main_8c-source.html#l00029">driveTable</a>, <a class="el" href="main_8c-source.html#l00065">nextCommutationStep</a>, <a class="el" href="main_8c-source.html#l00050">nextDrivePattern</a>, and <a class="el" href="BLDC_8h-source.html#l00213">SET_TIMER0_INT_ZC_DETECTION</a>.<div class="fragment"><pre class="fragment"><a name="l00508"></a>00508 {
<a name="l00509"></a>00509   <span class="comment">// Enable TCNT0 overflow ISR.</span>
<a name="l00510"></a>00510   <a class="code" href="BLDC_8h.html#a57">CLEAR_ALL_TIMER0_INT_FLAGS</a>;
<a name="l00511"></a>00511   <a class="code" href="BLDC_8h.html#a60">CLEAR_ALL_TIMER1_INT_FLAGS</a>;
<a name="l00512"></a>00512   <a class="code" href="BLDC_8h.html#a59">SET_TIMER0_INT_ZC_DETECTION</a>;
<a name="l00513"></a>00513   <a class="code" href="BLDC_8h.html#a61">DISABLE_ALL_TIMER1_INTS</a>;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   <span class="comment">// Set up ADC for zero-cross detection</span>
<a name="l00516"></a>00516   ADMUX = <a class="code" href="main_8c.html#a1">ADMUXTable</a>[<a class="code" href="main_8c.html#a6">nextCommutationStep</a>];
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   <span class="comment">// Wait for ADC to complete</span>
<a name="l00519"></a>00519   <span class="keywordflow">while</span> (!(ADCSRA &amp; (1 &lt;&lt; ADIF)))
<a name="l00520"></a>00520   {
<a name="l00521"></a>00521 
<a name="l00522"></a>00522   }
<a name="l00523"></a>00523   ADCSRA &amp;= ~(1 &lt;&lt; ADIE);
<a name="l00524"></a>00524   ADCSRA |= (1 &lt;&lt; ADSC) | (1 &lt;&lt; ADATE);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526   <span class="comment">// Rotate commutation step counter.</span>
<a name="l00527"></a>00527   <a class="code" href="main_8c.html#a6">nextCommutationStep</a>++;
<a name="l00528"></a>00528   <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a6">nextCommutationStep</a> &gt;= 6)
<a name="l00529"></a>00529   {
<a name="l00530"></a>00530     <a class="code" href="main_8c.html#a6">nextCommutationStep</a> = 0;
<a name="l00531"></a>00531   }
<a name="l00532"></a>00532   <a class="code" href="main_8c.html#a4">nextDrivePattern</a> = <a class="code" href="main_8c.html#a0">driveTable</a>[<a class="code" href="main_8c.html#a6">nextCommutationStep</a>];
<a name="l00533"></a>00533 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a16"></a><!-- doxytag: member="main.c::InitADC" ref="a16" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void InitADC           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes the AD-converter. 
<p>
This function initializes the AD-converter and makes a reading of the external reference voltage.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00211">211</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00174">ADC_PRESCALER_16</a>, <a class="el" href="BLDC_8h-source.html#l00171">ADC_PRESCALER_8</a>, <a class="el" href="BLDC_8h-source.html#l00180">ADC_TRIGGER_SOURCE</a>, <a class="el" href="BLDC_8h-source.html#l00168">ADMUX_REF_VOLTAGE</a>, and <a class="el" href="main_8c-source.html#l00074">referenceVoltageADC</a>.<div class="fragment"><pre class="fragment"><a name="l00212"></a>00212 {
<a name="l00213"></a>00213   <span class="comment">// First make a measurement of the external reference voltage.</span>
<a name="l00214"></a>00214   ADMUX = <a class="code" href="BLDC_8h.html#a46">ADMUX_REF_VOLTAGE</a>;
<a name="l00215"></a>00215   ADCSRA = (1 &lt;&lt; ADEN) | (1 &lt;&lt; ADSC) | (1 &lt;&lt; ADIF) | (<a class="code" href="BLDC_8h.html#a48">ADC_PRESCALER_16</a>);
<a name="l00216"></a>00216   <span class="keywordflow">while</span> (ADCSRA &amp; (1 &lt;&lt; ADSC))
<a name="l00217"></a>00217   {
<a name="l00218"></a>00218 
<a name="l00219"></a>00219   }
<a name="l00220"></a>00220   <a class="code" href="main_8c.html#a9">referenceVoltageADC</a> = ADCH;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="comment">// Initialize the ADC for autotriggered operation on PWM timer overflow.</span>
<a name="l00223"></a>00223   ADCSRA = (1 &lt;&lt; ADEN) | (0 &lt;&lt; ADSC) | (1 &lt;&lt; ADATE) | (1 &lt;&lt; ADIF) | (0 &lt;&lt; ADIE) | <a class="code" href="BLDC_8h.html#a47">ADC_PRESCALER_8</a>;
<a name="l00224"></a>00224   ADCSRB = <a class="code" href="BLDC_8h.html#a50">ADC_TRIGGER_SOURCE</a>;
<a name="l00225"></a>00225 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a17"></a><!-- doxytag: member="main.c::InitAnalogComparator" ref="a17" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void InitAnalogComparator           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes the analog comparator. 
<p>
This function initializes the analog comparator for overcurrent detection.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00232">232</a> of file <a class="el" href="main_8c-source.html">main.c</a>.<div class="fragment"><pre class="fragment"><a name="l00233"></a>00233 {
<a name="l00234"></a>00234 <span class="preprocessor">#ifdef ANALOG_COMPARATOR_ENABLE</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>  <span class="comment">// Enable analog comparator interrupt on rising edge.</span>
<a name="l00236"></a>00236   ACSR = (0 &lt;&lt; ACBG) | (1 &lt;&lt; ACI) | (1 &lt;&lt; ACIE) | (1 &lt;&lt; ACIS1) | (1 &lt;&lt; ACIS0);
<a name="l00237"></a>00237 <span class="preprocessor">#endif</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>}
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a14"></a><!-- doxytag: member="main.c::InitPorts" ref="a14" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void InitPorts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes I/O ports. 
<p>
Initializes I/O ports.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00174">174</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00117">DRIVE_DDR</a>, <a class="el" href="BLDC_8h-source.html#l00045">UH</a>, <a class="el" href="BLDC_8h-source.html#l00042">UL</a>, <a class="el" href="BLDC_8h-source.html#l00051">VH</a>, <a class="el" href="BLDC_8h-source.html#l00048">VL</a>, <a class="el" href="BLDC_8h-source.html#l00057">WH</a>, and <a class="el" href="BLDC_8h-source.html#l00054">WL</a>.<div class="fragment"><pre class="fragment"><a name="l00175"></a>00175 {
<a name="l00176"></a>00176   <span class="comment">// Init DRIVE_DDR for motor driving.</span>
<a name="l00177"></a>00177   <a class="code" href="BLDC_8h.html#a29">DRIVE_DDR</a> = (1 &lt;&lt; <a class="code" href="BLDC_8h.html#a5">UL</a>) | (1 &lt;&lt; <a class="code" href="BLDC_8h.html#a6">UH</a>) | (1 &lt;&lt; <a class="code" href="BLDC_8h.html#a7">VL</a>) | (1 &lt;&lt; <a class="code" href="BLDC_8h.html#a8">VH</a>) | (1 &lt;&lt; <a class="code" href="BLDC_8h.html#a9">WL</a>) | (1 &lt;&lt; <a class="code" href="BLDC_8h.html#a10">WH</a>);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179   <span class="comment">// Init PORTD for PWM on PD5.</span>
<a name="l00180"></a>00180   DDRD = (1 &lt;&lt; PD5);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182   <span class="comment">// Disable digital input buffers on ADC channels.</span>
<a name="l00183"></a>00183   DIDR0 = (1 &lt;&lt; ADC4D) | (1 &lt;&lt; ADC3D) | (1 &lt;&lt; ADC2D) | (1 &lt;&lt; ADC1D) | (1 &lt;&lt; ADC0D);
<a name="l00184"></a>00184 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a15"></a><!-- doxytag: member="main.c::InitTimers" ref="a15" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void InitTimers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes timers (for commutation timing and PWM). 
<p>
This function initializes Timer/counter0 for PWM operation for motor speed control and Timer/counter1 for commutation timing.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00192">192</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00033">PWM_TOP_VALUE</a>.<div class="fragment"><pre class="fragment"><a name="l00193"></a>00193 {
<a name="l00194"></a>00194   <span class="comment">// Set up Timer/counter0 for PWM, output on OCR0B, OCR0A as TOP value, prescaler = 1.</span>
<a name="l00195"></a>00195   TCCR0A = (0 &lt;&lt; COM0A1) | (0 &lt;&lt; COM0A0) | (1 &lt;&lt; COM0B1) | (0 &lt;&lt; COM0B0) | (0 &lt;&lt; WGM01) | (1 &lt;&lt; WGM00);
<a name="l00196"></a>00196   TCCR0B = (1 &lt;&lt; WGM02) | (0 &lt;&lt; CS02) | (0 &lt;&lt; CS01) | (1 &lt;&lt; CS00);
<a name="l00197"></a>00197   OCR0A = <a class="code" href="BLDC_8h.html#a2">PWM_TOP_VALUE</a>;
<a name="l00198"></a>00198   TIFR0 = TIFR0;
<a name="l00199"></a>00199   TIMSK0 = (0 &lt;&lt; TOIE0);
<a name="l00200"></a>00200 
<a name="l00201"></a>00201   <span class="comment">// Set up Timer/counter1 for commutation timing, prescaler = 8.</span>
<a name="l00202"></a>00202   TCCR1B = (1 &lt;&lt; CS11) | (0 &lt;&lt; CS10);
<a name="l00203"></a>00203 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a12"></a><!-- doxytag: member="main.c::main" ref="a12" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void main           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Program entry point. 
<p>
Main initializes all peripheral units used and calls the startup procedure. All commutation control from that point is done in interrupt routines.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00088">88</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h.html#a89">InitADC()</a>, <a class="el" href="BLDC_8h.html#a90">InitAnalogComparator()</a>, <a class="el" href="BLDC_8h.html#a87">InitPorts()</a>, <a class="el" href="BLDC_8h.html#a88">InitTimers()</a>, <a class="el" href="BLDC_8h.html#a92">MakeTables()</a>, <a class="el" href="BLDC_8h.html#a94">PWMControl()</a>, <a class="el" href="BLDC_8h.html#a86">ResetHandler()</a>, <a class="el" href="BLDC_8h.html#a93">StartMotor()</a>, and <a class="el" href="BLDC_8h.html#a91">WatchdogTimerEnable()</a>.<div class="fragment"><pre class="fragment"><a name="l00089"></a>00089 {
<a name="l00090"></a>00090   <span class="comment">// Initialize all sub-systems.</span>
<a name="l00091"></a>00091   <a class="code" href="BLDC_8h.html#a86">ResetHandler</a>();
<a name="l00092"></a>00092   <a class="code" href="BLDC_8h.html#a87">InitPorts</a>();
<a name="l00093"></a>00093   <a class="code" href="BLDC_8h.html#a88">InitTimers</a>();
<a name="l00094"></a>00094   <a class="code" href="BLDC_8h.html#a89">InitADC</a>();
<a name="l00095"></a>00095   <a class="code" href="BLDC_8h.html#a92">MakeTables</a>();
<a name="l00096"></a>00096   <a class="code" href="BLDC_8h.html#a90">InitAnalogComparator</a>();
<a name="l00097"></a>00097 
<a name="l00098"></a>00098   <span class="comment">// Run startup procedure.</span>
<a name="l00099"></a>00099   <a class="code" href="BLDC_8h.html#a93">StartMotor</a>();
<a name="l00100"></a>00100 
<a name="l00101"></a>00101   <span class="comment">// Turn on watchdog for stall-detection.</span>
<a name="l00102"></a>00102   <a class="code" href="BLDC_8h.html#a91">WatchdogTimerEnable</a>();
<a name="l00103"></a>00103   __enable_interrupt();
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   <span class="keywordflow">for</span>(;;)
<a name="l00106"></a>00106   {
<a name="l00107"></a>00107     <a class="code" href="BLDC_8h.html#a94">PWMControl</a>();
<a name="l00108"></a>00108   }
<a name="l00109"></a>00109 }
</pre></div>
<p>

<p>
Here is the call graph for this function:<p><center><img src="main_8c_a12_cgraph.png" border="0" usemap="#main_8c_a12_cgraph_map" alt=""></center>
<map name="main_8c_a12_cgraph_map">
<area href="BLDC_8h.html#a89" shape="rect" coords="155,7,222,33" alt="">
<area href="BLDC_8h.html#a90" shape="rect" coords="112,57,264,84" alt="">
<area href="BLDC_8h.html#a87" shape="rect" coords="152,108,224,135" alt="">
<area href="BLDC_8h.html#a88" shape="rect" coords="148,159,228,185" alt="">
<area href="BLDC_8h.html#a92" shape="rect" coords="142,209,235,236" alt="">
<area href="BLDC_8h.html#a94" shape="rect" coords="139,260,238,287" alt="">
<area href="BLDC_8h.html#a86" shape="rect" coords="136,311,240,337" alt="">
<area href="BLDC_8h.html#a93" shape="rect" coords="146,361,231,388" alt="">
<area href="BLDC_8h.html#a91" shape="rect" coords="110,412,267,439" alt="">
</map>
    </td>
  </tr>
</table>
<a class="anchor" name="a19"></a><!-- doxytag: member="main.c::MakeTables" ref="a19" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void MakeTables           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes arrays for motor driving and AD channel selection. 
<p>
This function initializes the arrays used for motor driving and AD channel selection that changes for each commutation step.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00262">262</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00153">ADMUX_U</a>, <a class="el" href="BLDC_8h-source.html#l00156">ADMUX_V</a>, <a class="el" href="BLDC_8h-source.html#l00159">ADMUX_W</a>, <a class="el" href="main_8c-source.html#l00032">ADMUXTable</a>, <a class="el" href="BLDC_8h-source.html#l00071">DRIVE_PATTERN_STEP1_CCW</a>, <a class="el" href="BLDC_8h-source.html#l00090">DRIVE_PATTERN_STEP1_CW</a>, <a class="el" href="BLDC_8h-source.html#l00074">DRIVE_PATTERN_STEP2_CCW</a>, <a class="el" href="BLDC_8h-source.html#l00093">DRIVE_PATTERN_STEP2_CW</a>, <a class="el" href="BLDC_8h-source.html#l00077">DRIVE_PATTERN_STEP3_CCW</a>, <a class="el" href="BLDC_8h-source.html#l00096">DRIVE_PATTERN_STEP3_CW</a>, <a class="el" href="BLDC_8h-source.html#l00080">DRIVE_PATTERN_STEP4_CCW</a>, <a class="el" href="BLDC_8h-source.html#l00099">DRIVE_PATTERN_STEP4_CW</a>, <a class="el" href="BLDC_8h-source.html#l00083">DRIVE_PATTERN_STEP5_CCW</a>, <a class="el" href="BLDC_8h-source.html#l00102">DRIVE_PATTERN_STEP5_CW</a>, <a class="el" href="BLDC_8h-source.html#l00086">DRIVE_PATTERN_STEP6_CCW</a>, <a class="el" href="BLDC_8h-source.html#l00105">DRIVE_PATTERN_STEP6_CW</a>, <a class="el" href="main_8c-source.html#l00029">driveTable</a>, and <a class="el" href="main_8c-source.html#l00035">startupDelays</a>.<div class="fragment"><pre class="fragment"><a name="l00263"></a>00263 {
<a name="l00264"></a>00264 <span class="preprocessor">#if DIRECTION_OF_ROTATION == CCW</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span>  <a class="code" href="main_8c.html#a0">driveTable</a>[0] = <a class="code" href="BLDC_8h.html#a14">DRIVE_PATTERN_STEP1_CCW</a>;
<a name="l00266"></a>00266   <a class="code" href="main_8c.html#a0">driveTable</a>[1] = <a class="code" href="BLDC_8h.html#a15">DRIVE_PATTERN_STEP2_CCW</a>;
<a name="l00267"></a>00267   <a class="code" href="main_8c.html#a0">driveTable</a>[2] = <a class="code" href="BLDC_8h.html#a16">DRIVE_PATTERN_STEP3_CCW</a>;
<a name="l00268"></a>00268   <a class="code" href="main_8c.html#a0">driveTable</a>[3] = <a class="code" href="BLDC_8h.html#a17">DRIVE_PATTERN_STEP4_CCW</a>;
<a name="l00269"></a>00269   <a class="code" href="main_8c.html#a0">driveTable</a>[4] = <a class="code" href="BLDC_8h.html#a18">DRIVE_PATTERN_STEP5_CCW</a>;
<a name="l00270"></a>00270   <a class="code" href="main_8c.html#a0">driveTable</a>[5] = <a class="code" href="BLDC_8h.html#a19">DRIVE_PATTERN_STEP6_CCW</a>;
<a name="l00271"></a>00271 
<a name="l00272"></a>00272   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[0] = <a class="code" href="BLDC_8h.html#a43">ADMUX_W</a>;
<a name="l00273"></a>00273   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[1] = <a class="code" href="BLDC_8h.html#a42">ADMUX_V</a>;
<a name="l00274"></a>00274   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[2] = <a class="code" href="BLDC_8h.html#a41">ADMUX_U</a>;
<a name="l00275"></a>00275   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[3] = <a class="code" href="BLDC_8h.html#a43">ADMUX_W</a>;
<a name="l00276"></a>00276   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[4] = <a class="code" href="BLDC_8h.html#a42">ADMUX_V</a>;
<a name="l00277"></a>00277   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[5] = <a class="code" href="BLDC_8h.html#a41">ADMUX_U</a>;
<a name="l00278"></a>00278 <span class="preprocessor">#else</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>  <a class="code" href="main_8c.html#a0">driveTable</a>[0] = <a class="code" href="BLDC_8h.html#a20">DRIVE_PATTERN_STEP1_CW</a>;
<a name="l00280"></a>00280   <a class="code" href="main_8c.html#a0">driveTable</a>[1] = <a class="code" href="BLDC_8h.html#a21">DRIVE_PATTERN_STEP2_CW</a>;
<a name="l00281"></a>00281   <a class="code" href="main_8c.html#a0">driveTable</a>[2] = <a class="code" href="BLDC_8h.html#a22">DRIVE_PATTERN_STEP3_CW</a>;
<a name="l00282"></a>00282   <a class="code" href="main_8c.html#a0">driveTable</a>[3] = <a class="code" href="BLDC_8h.html#a23">DRIVE_PATTERN_STEP4_CW</a>;
<a name="l00283"></a>00283   <a class="code" href="main_8c.html#a0">driveTable</a>[4] = <a class="code" href="BLDC_8h.html#a24">DRIVE_PATTERN_STEP5_CW</a>;
<a name="l00284"></a>00284   <a class="code" href="main_8c.html#a0">driveTable</a>[5] = <a class="code" href="BLDC_8h.html#a25">DRIVE_PATTERN_STEP6_CW</a>;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[0] = <a class="code" href="BLDC_8h.html#a41">ADMUX_U</a>;
<a name="l00287"></a>00287   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[1] = <a class="code" href="BLDC_8h.html#a42">ADMUX_V</a>;
<a name="l00288"></a>00288   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[2] = <a class="code" href="BLDC_8h.html#a43">ADMUX_W</a>;
<a name="l00289"></a>00289   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[3] = <a class="code" href="BLDC_8h.html#a41">ADMUX_U</a>;
<a name="l00290"></a>00290   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[4] = <a class="code" href="BLDC_8h.html#a42">ADMUX_V</a>;
<a name="l00291"></a>00291   <a class="code" href="main_8c.html#a1">ADMUXTable</a>[5] = <a class="code" href="BLDC_8h.html#a43">ADMUX_W</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 <span class="preprocessor">#endif</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span>
<a name="l00295"></a>00295   <a class="code" href="main_8c.html#a2">startupDelays</a>[0] = 200;
<a name="l00296"></a>00296   <a class="code" href="main_8c.html#a2">startupDelays</a>[1] = 150;
<a name="l00297"></a>00297   <a class="code" href="main_8c.html#a2">startupDelays</a>[2] = 100;
<a name="l00298"></a>00298   <a class="code" href="main_8c.html#a2">startupDelays</a>[3] = 80;
<a name="l00299"></a>00299   <a class="code" href="main_8c.html#a2">startupDelays</a>[4] = 70;
<a name="l00300"></a>00300   <a class="code" href="main_8c.html#a2">startupDelays</a>[5] = 65;
<a name="l00301"></a>00301   <a class="code" href="main_8c.html#a2">startupDelays</a>[6] = 60;
<a name="l00302"></a>00302   <a class="code" href="main_8c.html#a2">startupDelays</a>[7] = 55;
<a name="l00303"></a>00303 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a21"></a><!-- doxytag: member="main.c::MotorPWMBottom" ref="a21" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__interrupt void MotorPWMBottom           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Timer/counter0 bottom overflow. Used for zero-cross detection. 
<p>
This interrupt service routine is called every time the up/down counting PWM counter reaches bottom. An ADC reading on the active channel is automatically triggered at the same time as this interrupt is triggered. This is used to detect a zero crossing.<p>
In the event of a zero crossing, the time since last commutation is stored and Timer/counter1 compare A is set up to trigger at the next commutation instant.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00364">364</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00177">ADC_PRESCALER</a>, <a class="el" href="BLDC_8h-source.html#l00290">ADC_ZC_THRESHOLD</a>, <a class="el" href="BLDC_8h-source.html#l00165">ADMUX_CURRENT</a>, <a class="el" href="BLDC_8h-source.html#l00168">ADMUX_REF_VOLTAGE</a>, <a class="el" href="BLDC_8h-source.html#l00162">ADMUX_SPEED_REF</a>, <a class="el" href="BLDC_8h-source.html#l00216">CLEAR_ALL_TIMER1_INT_FLAGS</a>, <a class="el" href="BLDC_8h-source.html#l00296">COMMUTATION_CORRECTION</a>, <a class="el" href="BLDC_8h-source.html#l00251">COMMUTATION_TIMING_IIR_COEFF_A</a>, <a class="el" href="BLDC_8h-source.html#l00259">COMMUTATION_TIMING_IIR_COEFF_B</a>, <a class="el" href="main_8c-source.html#l00080">currentUpdated</a>, <a class="el" href="BLDC_8h-source.html#l00210">DISABLE_ALL_TIMER0_INTS</a>, <a class="el" href="BLDC_8h-source.html#l00108">EDGE_FALLING</a>, <a class="el" href="BLDC_8h-source.html#l00111">EDGE_RISING</a>, <a class="el" href="main_8c-source.html#l00042">filteredTimeSinceCommutation</a>, <a class="el" href="main_8c-source.html#l00074">referenceVoltageADC</a>, <a class="el" href="BLDC_8h-source.html#l00222">SET_TIMER1_INT_COMMUTATION</a>, <a class="el" href="main_8c-source.html#l00071">shuntVoltageADC</a>, <a class="el" href="main_8c-source.html#l00068">speedReferenceADC</a>, <a class="el" href="main_8c-source.html#l00077">speedUpdated</a>, <a class="el" href="BLDC_8h-source.html#l00039">TRUE</a>, and <a class="el" href="main_8c-source.html#l00057">zcPolarity</a>.<div class="fragment"><pre class="fragment"><a name="l00365"></a>00365 {
<a name="l00366"></a>00366   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> temp;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   <span class="comment">// Disable ADC auto-triggering. This must be done here to avoid wrong channel being sampled on manual samples later.</span>
<a name="l00369"></a>00369   ADCSRA &amp;= ~((1 &lt;&lt; ADATE) | (1 &lt;&lt; ADIE));
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <span class="comment">// Wait for auto-triggered ADC sample to complete.</span>
<a name="l00372"></a>00372   <span class="keywordflow">while</span> (!(ADCSRA &amp; (1 &lt;&lt; ADIF)))
<a name="l00373"></a>00373   {
<a name="l00374"></a>00374 
<a name="l00375"></a>00375   }
<a name="l00376"></a>00376   temp = ADCH;
<a name="l00377"></a>00377   <span class="keywordflow">if</span> (((<a class="code" href="main_8c.html#a5">zcPolarity</a> == <a class="code" href="BLDC_8h.html#a27">EDGE_RISING</a>) &amp;&amp; (temp &gt; <a class="code" href="BLDC_8h.html#a78">ADC_ZC_THRESHOLD</a>)) || ((<a class="code" href="main_8c.html#a5">zcPolarity</a> == <a class="code" href="BLDC_8h.html#a26">EDGE_FALLING</a>) &amp;&amp; (temp &lt; <a class="code" href="BLDC_8h.html#a78">ADC_ZC_THRESHOLD</a>)))
<a name="l00378"></a>00378   {
<a name="l00379"></a>00379     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeSinceCommutation;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="comment">// Find time since last commutation</span>
<a name="l00382"></a>00382     timeSinceCommutation = TCNT1;
<a name="l00383"></a>00383     TCNT1 = <a class="code" href="BLDC_8h.html#a79">COMMUTATION_CORRECTION</a>;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="comment">// Filter the current ZC detection with earlier measurements through an IIR filter.</span>
<a name="l00386"></a>00386     <a class="code" href="main_8c.html#a3">filteredTimeSinceCommutation</a> = (<a class="code" href="BLDC_8h.html#a69">COMMUTATION_TIMING_IIR_COEFF_A</a> * timeSinceCommutation
<a name="l00387"></a>00387                                 + <a class="code" href="BLDC_8h.html#a70">COMMUTATION_TIMING_IIR_COEFF_B</a> * <a class="code" href="main_8c.html#a3">filteredTimeSinceCommutation</a>)
<a name="l00388"></a>00388                                 / (<a class="code" href="BLDC_8h.html#a69">COMMUTATION_TIMING_IIR_COEFF_A</a> + <a class="code" href="BLDC_8h.html#a70">COMMUTATION_TIMING_IIR_COEFF_B</a>);
<a name="l00389"></a>00389     OCR1A = <a class="code" href="main_8c.html#a3">filteredTimeSinceCommutation</a>;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <a class="code" href="main_8c.html#a10">speedUpdated</a> = <a class="code" href="BLDC_8h.html#a4">TRUE</a>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     <a class="code" href="BLDC_8h.html#a62">SET_TIMER1_INT_COMMUTATION</a>;
<a name="l00394"></a>00394     <a class="code" href="BLDC_8h.html#a60">CLEAR_ALL_TIMER1_INT_FLAGS</a>;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     <span class="comment">// Disable Timer/Counter0 overflow ISR.</span>
<a name="l00397"></a>00397     <a class="code" href="BLDC_8h.html#a58">DISABLE_ALL_TIMER0_INTS</a>;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="comment">// Read speed reference.</span>
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">// Make sure that a sample is not in progress.</span>
<a name="l00402"></a>00402     <span class="keywordflow">while</span> (ADCSRA &amp; (1 &lt;&lt; ADSC))
<a name="l00403"></a>00403     {
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406     <span class="comment">// Change channel</span>
<a name="l00407"></a>00407     ADMUX = <a class="code" href="BLDC_8h.html#a44">ADMUX_SPEED_REF</a>;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="comment">// Start conversion manually.</span>
<a name="l00410"></a>00410     ADCSRA |= (1 &lt;&lt; ADSC);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="comment">// Wait for conversion to complete.</span>
<a name="l00413"></a>00413     <span class="keywordflow">while</span>((ADCSRA &amp; (1 &lt;&lt; ADSC)))
<a name="l00414"></a>00414     {
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417     <a class="code" href="main_8c.html#a7">speedReferenceADC</a> = ADCH;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="comment">// Read voltage reference.</span>
<a name="l00420"></a>00420     <span class="comment">// Change ADC channel.</span>
<a name="l00421"></a>00421     ADMUX = <a class="code" href="BLDC_8h.html#a46">ADMUX_REF_VOLTAGE</a>;
<a name="l00422"></a>00422     <span class="comment">// Start conversion manually.</span>
<a name="l00423"></a>00423     ADCSRA |= (1 &lt;&lt; ADSC);
<a name="l00424"></a>00424     <span class="comment">// Wait for conversion to complete.</span>
<a name="l00425"></a>00425     <span class="keywordflow">while</span>((ADCSRA &amp; (1 &lt;&lt; ADSC)))
<a name="l00426"></a>00426     {
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429     <a class="code" href="main_8c.html#a9">referenceVoltageADC</a> = ADCH;
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="comment">// Enable current measurements in ADC ISR.</span>
<a name="l00432"></a>00432     ADMUX = <a class="code" href="BLDC_8h.html#a45">ADMUX_CURRENT</a>;
<a name="l00433"></a>00433     ADCSRA |= (1 &lt;&lt; ADATE) | (1 &lt;&lt; ADIE) | <a class="code" href="BLDC_8h.html#a49">ADC_PRESCALER</a>;
<a name="l00434"></a>00434   }
<a name="l00435"></a>00435   <span class="keywordflow">else</span>
<a name="l00436"></a>00436   {
<a name="l00437"></a>00437     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tempADMUX;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     tempADMUX = ADMUX;
<a name="l00440"></a>00440     <span class="comment">// Read current</span>
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="comment">// Make sure that a sample is not in progress</span>
<a name="l00443"></a>00443     <span class="keywordflow">while</span> (ADCSRA &amp; (1 &lt;&lt; ADSC))
<a name="l00444"></a>00444     {
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     <span class="comment">// Change channel</span>
<a name="l00449"></a>00449     ADMUX = <a class="code" href="BLDC_8h.html#a45">ADMUX_CURRENT</a>;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="comment">// Start conversion manually.</span>
<a name="l00452"></a>00452     ADCSRA |= (1 &lt;&lt; ADSC);
<a name="l00453"></a>00453     <span class="comment">// Wait for conversion to complete.</span>
<a name="l00454"></a>00454     <span class="keywordflow">while</span>((ADCSRA &amp; (1 &lt;&lt; ADSC)))
<a name="l00455"></a>00455     {
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <a class="code" href="main_8c.html#a8">shuntVoltageADC</a> = ADCH;
<a name="l00460"></a>00460     <a class="code" href="main_8c.html#a11">currentUpdated</a> = <a class="code" href="BLDC_8h.html#a4">TRUE</a>;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="comment">// Restore ADC channel.</span>
<a name="l00463"></a>00463     ADMUX = tempADMUX;
<a name="l00464"></a>00464     ADCSRA |= (1 &lt;&lt; ADATE) | (1 &lt;&lt; ADIE) | <a class="code" href="BLDC_8h.html#a49">ADC_PRESCALER</a>;
<a name="l00465"></a>00465   }
<a name="l00466"></a>00466 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a26"></a><!-- doxytag: member="main.c::OverCurrentISR" ref="a26" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__interrupt void OverCurrentISR           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Overcurrent interrupt. 
<p>
This interrupt service routine cuts power to the motor when an overcurrent situation is detected.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00575">575</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00284">DISABLE_DRIVING</a>.<div class="fragment"><pre class="fragment"><a name="l00576"></a>00576 {
<a name="l00577"></a>00577   <a class="code" href="BLDC_8h.html#a76">DISABLE_DRIVING</a>;
<a name="l00578"></a>00578   <span class="keywordflow">for</span>(;;)
<a name="l00579"></a>00579   {
<a name="l00580"></a>00580     ;
<a name="l00581"></a>00581   }
<a name="l00582"></a>00582 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a28"></a><!-- doxytag: member="main.c::PWMControl" ref="a28" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void PWMControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00655">655</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00234">ADC_RESOLUTION</a>, <a class="el" href="BLDC_8h-source.html#l00302">MAX_PWM_COMPARE_VALUE</a>, <a class="el" href="BLDC_8h-source.html#l00299">MIN_PWM_COMPARE_VALUE</a>, <a class="el" href="BLDC_8h-source.html#l00204">SET_PWM_COMPARE_VALUE</a>, <a class="el" href="main_8c-source.html#l00068">speedReferenceADC</a>, and <a class="el" href="main_8c-source.html#l00077">speedUpdated</a>.<div class="fragment"><pre class="fragment"><a name="l00656"></a>00656 {
<a name="l00657"></a>00657   <span class="comment">// Only update duty cycle if a new speed reference measurement has been made. (Done right after speed measurement is ready)</span>
<a name="l00658"></a>00658   <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a10">speedUpdated</a>)
<a name="l00659"></a>00659   {
<a name="l00660"></a>00660     <span class="comment">// Calculate duty cycle from speed reference value.</span>
<a name="l00661"></a>00661     <a class="code" href="BLDC_8h.html#a56">SET_PWM_COMPARE_VALUE</a>(<a class="code" href="BLDC_8h.html#a80">MIN_PWM_COMPARE_VALUE</a> + <a class="code" href="main_8c.html#a7">speedReferenceADC</a> * (<a class="code" href="BLDC_8h.html#a81">MAX_PWM_COMPARE_VALUE</a> - <a class="code" href="BLDC_8h.html#a80">MIN_PWM_COMPARE_VALUE</a>) / <a class="code" href="BLDC_8h.html#a66">ADC_RESOLUTION</a>);
<a name="l00662"></a>00662   }
<a name="l00663"></a>00663 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a13"></a><!-- doxytag: member="main.c::ResetHandler" ref="a13" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void ResetHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Examines the reset source and acts accordingly. 
<p>
This function is called early in the program to disable watchdog timer and determine the source of reset.<p>
Actions can be taken, based on the reset source. When the watchdog is used as stall protection, a stall can be detected here. It is possible to e.g. store a variable in EEPROM that counts the number of failed restart attempts. After a certain number of attempts, the motor could simply refuse to continue until an external action happens, indicating that the rotor lock situation could be fixed.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00124">124</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00198">MAX_RESTART_ATTEMPTS</a>.<div class="fragment"><pre class="fragment"><a name="l00125"></a>00125 {
<a name="l00126"></a>00126   __eeprom <span class="keywordtype">unsigned</span> <span class="keyword">static</span> <span class="keywordtype">int</span> restartAttempts;
<a name="l00127"></a>00127   <span class="comment">// Temporary variable to avoid unnecessary reading of volatile register MCUSR.</span>
<a name="l00128"></a>00128   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tempMCUSR;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   tempMCUSR = MCUSR;
<a name="l00131"></a>00131   MCUSR = tempMCUSR &amp; ~((1 &lt;&lt; WDRF) | (1 &lt;&lt; BORF) | (1 &lt;&lt; EXTRF) | (1 &lt;&lt; PORF));
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   <span class="comment">// Reset watchdog to avoid false stall detection before the motor has started.</span>
<a name="l00134"></a>00134   __disable_interrupt();
<a name="l00135"></a>00135   __watchdog_reset();
<a name="l00136"></a>00136   WDTCSR |= (1 &lt;&lt; WDCE) | (1 &lt;&lt; WDE);
<a name="l00137"></a>00137   WDTCSR = 0x00;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139   <span class="comment">// Examine the reset source and take action.</span>
<a name="l00140"></a>00140   <span class="keywordflow">switch</span> (tempMCUSR &amp; ((1 &lt;&lt; WDRF) | (1 &lt;&lt; BORF) | (1 &lt;&lt; EXTRF) | (1 &lt;&lt; PORF)))
<a name="l00141"></a>00141   {
<a name="l00142"></a>00142   <span class="keywordflow">case</span> (1 &lt;&lt; WDRF):
<a name="l00143"></a>00143     restartAttempts++;
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (restartAttempts &gt;= <a class="code" href="BLDC_8h.html#a54">MAX_RESTART_ATTEMPTS</a>)
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146       <span class="comment">// Do something here. E.g. wait for a button to be pressed.</span>
<a name="l00147"></a>00147       <span class="keywordflow">for</span> (;;)
<a name="l00148"></a>00148       {
<a name="l00149"></a>00149 
<a name="l00150"></a>00150       }
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="comment">// Put watchdog reset handler here.</span>
<a name="l00154"></a>00154     <span class="keywordflow">break</span>;
<a name="l00155"></a>00155   <span class="keywordflow">case</span> (1 &lt;&lt; BORF):
<a name="l00156"></a>00156     <span class="comment">//Put brownout reset handler here.</span>
<a name="l00157"></a>00157     <span class="keywordflow">break</span>;
<a name="l00158"></a>00158   <span class="keywordflow">case</span> (1 &lt;&lt; EXTRF):
<a name="l00159"></a>00159     restartAttempts = 0;
<a name="l00160"></a>00160     <span class="comment">// Put external reset handler here.</span>
<a name="l00161"></a>00161     <span class="keywordflow">break</span>;
<a name="l00162"></a>00162   <span class="keywordflow">case</span> (1 &lt;&lt; PORF):
<a name="l00163"></a>00163     restartAttempts = 0;
<a name="l00164"></a>00164     <span class="comment">// Put power-on reset handler here.</span>
<a name="l00165"></a>00165     <span class="keywordflow">break</span>;
<a name="l00166"></a>00166   }
<a name="l00167"></a>00167 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a32"></a><!-- doxytag: member="main.c::SpeedControl" ref="a32" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static signed int SpeedControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Speed control loop. 
<p>
This function runs a simple P-regulator speed control loop. The duty cycle is only updated each time a new speed measurement is ready (on each zero-crossing). The time step is thus variable, so the P-gain of the P-regulator corresponds to a speed-varying P-gain for the continous system.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00742">742</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h.html#a96">CalculateSpeed()</a>, <a class="el" href="BLDC_8h.html#a97">CalculateSpeedSetpoint()</a>, <a class="el" href="BLDC_8h-source.html#l00311">P_REG_K_P</a>, and <a class="el" href="BLDC_8h-source.html#l00314">P_REG_SCALING</a>.<div class="fragment"><pre class="fragment"><a name="l00743"></a>00743 {
<a name="l00744"></a>00744   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> speedSetpoint;
<a name="l00745"></a>00745   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> currentSpeed;
<a name="l00746"></a>00746   <span class="keywordtype">signed</span> <span class="keywordtype">long</span> speedError;
<a name="l00747"></a>00747   <span class="keywordtype">signed</span> <span class="keywordtype">long</span> dutyChange;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   speedSetpoint = <a class="code" href="BLDC_8h.html#a97">CalculateSpeedSetpoint</a>();
<a name="l00752"></a>00752   currentSpeed = <a class="code" href="BLDC_8h.html#a96">CalculateSpeed</a>();
<a name="l00753"></a>00753   speedError = (speedSetpoint - currentSpeed);
<a name="l00754"></a>00754   dutyChange = speedError * <a class="code" href="BLDC_8h.html#a84">P_REG_K_P</a> / <a class="code" href="BLDC_8h.html#a85">P_REG_SCALING</a>;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756   <span class="keywordflow">return</span> dutyChange;
<a name="l00757"></a>00757 }
</pre></div>
<p>

<p>
Here is the call graph for this function:<p><center><img src="main_8c_a32_cgraph.png" border="0" usemap="#main_8c_a32_cgraph_map" alt=""></center>
<map name="main_8c_a32_cgraph_map">
<area href="BLDC_8h.html#a96" shape="rect" coords="184,7,299,34" alt="">
<area href="BLDC_8h.html#a97" shape="rect" coords="159,58,324,84" alt="">
</map>
    </td>
  </tr>
</table>
<a class="anchor" name="a20"></a><!-- doxytag: member="main.c::StartMotor" ref="a20" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void StartMotor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Executes the motor startup sequence. 
<p>
This function locks the motor into a known position and fires off a commutation sequence controlled by the Timer/counter1 overflow interrupt.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00311">311</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="main_8c-source.html#l00032">ADMUXTable</a>, <a class="el" href="BLDC_8h-source.html#l00114">DRIVE_PORT</a>, <a class="el" href="main_8c-source.html#l00029">driveTable</a>, <a class="el" href="main_8c-source.html#l00042">filteredTimeSinceCommutation</a>, <a class="el" href="main_8c-source.html#l00065">nextCommutationStep</a>, <a class="el" href="main_8c-source.html#l00050">nextDrivePattern</a>, <a class="el" href="BLDC_8h-source.html#l00204">SET_PWM_COMPARE_VALUE</a>, <a class="el" href="BLDC_8h-source.html#l00189">STARTUP_DELAY_MULTIPLIER</a>, <a class="el" href="BLDC_8h-source.html#l00195">STARTUP_LOCK_DELAY</a>, <a class="el" href="BLDC_8h-source.html#l00186">STARTUP_NUM_COMMUTATIONS</a>, <a class="el" href="BLDC_8h-source.html#l00287">STARTUP_PWM_COMPARE_VALUE</a>, <a class="el" href="main_8c-source.html#l00593">StartupDelay()</a>, <a class="el" href="main_8c-source.html#l00035">startupDelays</a>, and <a class="el" href="main_8c-source.html#l00057">zcPolarity</a>.<div class="fragment"><pre class="fragment"><a name="l00312"></a>00312 {
<a name="l00313"></a>00313   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315   <a class="code" href="BLDC_8h.html#a56">SET_PWM_COMPARE_VALUE</a>(<a class="code" href="BLDC_8h.html#a77">STARTUP_PWM_COMPARE_VALUE</a>);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317   <a class="code" href="main_8c.html#a6">nextCommutationStep</a> = 0;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="comment">//Preposition.</span>
<a name="l00320"></a>00320   <a class="code" href="BLDC_8h.html#a28">DRIVE_PORT</a> = <a class="code" href="main_8c.html#a0">driveTable</a>[<a class="code" href="main_8c.html#a6">nextCommutationStep</a>];
<a name="l00321"></a>00321   <a class="code" href="BLDC_8h.html#a95">StartupDelay</a>(<a class="code" href="BLDC_8h.html#a53">STARTUP_LOCK_DELAY</a>);
<a name="l00322"></a>00322   <a class="code" href="main_8c.html#a6">nextCommutationStep</a>++;
<a name="l00323"></a>00323   <a class="code" href="main_8c.html#a4">nextDrivePattern</a> = <a class="code" href="main_8c.html#a0">driveTable</a>[<a class="code" href="main_8c.html#a6">nextCommutationStep</a>];
<a name="l00324"></a>00324 
<a name="l00325"></a>00325   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="BLDC_8h.html#a51">STARTUP_NUM_COMMUTATIONS</a>; i++)
<a name="l00326"></a>00326   {
<a name="l00327"></a>00327     <a class="code" href="BLDC_8h.html#a28">DRIVE_PORT</a> = <a class="code" href="main_8c.html#a4">nextDrivePattern</a>;
<a name="l00328"></a>00328     <a class="code" href="BLDC_8h.html#a95">StartupDelay</a>(<a class="code" href="main_8c.html#a2">startupDelays</a>[i]);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     ADMUX = <a class="code" href="main_8c.html#a1">ADMUXTable</a>[<a class="code" href="main_8c.html#a6">nextCommutationStep</a>];
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="comment">// Use LSB of nextCommutationStep to determine zero crossing polarity.</span>
<a name="l00333"></a>00333     <a class="code" href="main_8c.html#a5">zcPolarity</a> = <a class="code" href="main_8c.html#a6">nextCommutationStep</a> &amp; 0x01;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <a class="code" href="main_8c.html#a6">nextCommutationStep</a>++;
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a6">nextCommutationStep</a> &gt;= 6)
<a name="l00337"></a>00337     {
<a name="l00338"></a>00338       <a class="code" href="main_8c.html#a6">nextCommutationStep</a> = 0;
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340     <a class="code" href="main_8c.html#a4">nextDrivePattern</a> = <a class="code" href="main_8c.html#a0">driveTable</a>[<a class="code" href="main_8c.html#a6">nextCommutationStep</a>];
<a name="l00341"></a>00341   }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343   <span class="comment">// Switch to sensorless commutation.</span>
<a name="l00344"></a>00344   TCNT1 = 0;
<a name="l00345"></a>00345   TIMSK1 = (1 &lt;&lt; OCIE1A);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347   <span class="comment">// Set filteredTimeSinceCommutation to the time to the next commutation.</span>
<a name="l00348"></a>00348   <a class="code" href="main_8c.html#a3">filteredTimeSinceCommutation</a> = <a class="code" href="main_8c.html#a2">startupDelays</a>[<a class="code" href="BLDC_8h.html#a51">STARTUP_NUM_COMMUTATIONS</a> - 1] * (<a class="code" href="BLDC_8h.html#a52">STARTUP_DELAY_MULTIPLIER</a>  / 2);
<a name="l00349"></a>00349 }
</pre></div>
<p>

<p>
Here is the call graph for this function:<p><center><img src="main_8c_a20_cgraph.png" border="0" usemap="#main_8c_a20_cgraph_map" alt=""></center>
<map name="main_8c_a20_cgraph_map">
<area href="BLDC_8h.html#a95" shape="rect" coords="141,7,240,33" alt="">
</map>
    </td>
  </tr>
</table>
<a class="anchor" name="a27"></a><!-- doxytag: member="main.c::StartupDelay" ref="a27" args="(unsigned int delay)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void StartupDelay           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>delay</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Generates a delay used during startup. 
<p>
This functions is used to generate a delay during the startup procedure. The length of the delay equals delay * STARTUP_DELAY_MULTIPLIER microseconds. Since Timer/Counter1 is used in this function, it must never be called when sensorless operation is running.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00593">593</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00216">CLEAR_ALL_TIMER1_INT_FLAGS</a>, and <a class="el" href="BLDC_8h-source.html#l00189">STARTUP_DELAY_MULTIPLIER</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.<div class="fragment"><pre class="fragment"><a name="l00594"></a>00594 {
<a name="l00595"></a>00595   <a class="code" href="BLDC_8h.html#a60">CLEAR_ALL_TIMER1_INT_FLAGS</a>;
<a name="l00596"></a>00596   <span class="keywordflow">do</span>
<a name="l00597"></a>00597   {
<a name="l00598"></a>00598     TCNT1 = 0xffff - <a class="code" href="BLDC_8h.html#a52">STARTUP_DELAY_MULTIPLIER</a>;
<a name="l00599"></a>00599     <span class="comment">// Wait for timer to overflow.</span>
<a name="l00600"></a>00600     <span class="keywordflow">while</span> (!(TIFR1 &amp; (1 &lt;&lt; TOV1)))
<a name="l00601"></a>00601     {
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <a class="code" href="BLDC_8h.html#a60">CLEAR_ALL_TIMER1_INT_FLAGS</a>;
<a name="l00606"></a>00606     delay--;
<a name="l00607"></a>00607   } <span class="keywordflow">while</span> (delay);
<a name="l00608"></a>00608 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a25"></a><!-- doxytag: member="main.c::WatchdogISR" ref="a25" args="()" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__interrupt void WatchdogISR           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Watchdog interrupt. 
<p>
This ISR is called before the watchdog timer resets the device because of a stall. It simply disables driving, but other tasks that must be done before a watchdog reset, such as storage of variables in non-volatile memory can be done here.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00559">559</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
References <a class="el" href="BLDC_8h-source.html#l00284">DISABLE_DRIVING</a>.<div class="fragment"><pre class="fragment"><a name="l00560"></a>00560 {
<a name="l00561"></a>00561   <a class="code" href="BLDC_8h.html#a76">DISABLE_DRIVING</a>;
<a name="l00562"></a>00562   <span class="keywordflow">for</span>(;;)
<a name="l00563"></a>00563   {
<a name="l00564"></a>00564     ;
<a name="l00565"></a>00565   }
<a name="l00566"></a>00566 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a18"></a><!-- doxytag: member="main.c::WatchdogTimerEnable" ref="a18" args="(void)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static void WatchdogTimerEnable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes the watchdog timer. 
<p>
This function initializes the watchdog timer for stall restart.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00245">245</a> of file <a class="el" href="main_8c-source.html">main.c</a>.<div class="fragment"><pre class="fragment"><a name="l00246"></a>00246 {
<a name="l00247"></a>00247   __disable_interrupt();
<a name="l00248"></a>00248   __watchdog_reset();
<a name="l00249"></a>00249 
<a name="l00250"></a>00250   WDTCSR |= (1 &lt;&lt; WDCE) | (1 &lt;&lt; WDE);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   WDTCSR = (1 &lt;&lt; WDIF) | (1 &lt;&lt; WDIE) | (1 &lt;&lt; WDE) | (1 &lt;&lt; WDP2);
<a name="l00253"></a>00253   __enable_interrupt();
<a name="l00254"></a>00254 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1"></a><!-- doxytag: member="main.c::ADMUXTable" ref="a1" args="[6]" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">unsigned char <a class="el" href="main_8c.html#a1">ADMUXTable</a>[6]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Array of ADC channel selections for each commutation step. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00032">32</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00507">EnableZCDetection()</a>, <a class="el" href="main_8c-source.html#l00262">MakeTables()</a>, and <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11"></a><!-- doxytag: member="main.c::currentUpdated" ref="a11" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">volatile unsigned char <a class="el" href="main_8c.html#a11">currentUpdated</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Flag that specifies whether a new current measurement is available. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00080">80</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00544">CurrentMeasurementComplete()</a>, and <a class="el" href="main_8c-source.html#l00364">MotorPWMBottom()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0"></a><!-- doxytag: member="main.c::driveTable" ref="a0" args="[6]" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">unsigned char <a class="el" href="main_8c.html#a0">driveTable</a>[6]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Array of power stage enable signals for each commutation step. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00029">29</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00507">EnableZCDetection()</a>, <a class="el" href="main_8c-source.html#l00262">MakeTables()</a>, and <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3"></a><!-- doxytag: member="main.c::filteredTimeSinceCommutation" ref="a3" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__regvar __no_init volatile unsigned int <a class="el" href="main_8c.html#a3">filteredTimeSinceCommutation</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Filtered commutation timer variable and speed indicator. This value equals half the time of one commutation step. It is filtered through an IIR filter, so the value stored is not the most recent measuremnt. The variable is stored in registers R14-R15 for quicker access. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00042">42</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00672">CalculateSpeed()</a>, <a class="el" href="main_8c-source.html#l00364">MotorPWMBottom()</a>, and <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6"></a><!-- doxytag: member="main.c::nextCommutationStep" ref="a6" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__regvar __no_init volatile unsigned char <a class="el" href="main_8c.html#a6">nextCommutationStep</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
The commutation step that starts at next commutation. 
<p>
The commutation step that starts at next commutation. This is used to keep track on where in the commutation cycle we are. Stored in register R11 for quick access
<p>
Definition at line <a class="el" href="main_8c-source.html#l00065">65</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00482">Commutate()</a>, <a class="el" href="main_8c-source.html#l00507">EnableZCDetection()</a>, and <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4"></a><!-- doxytag: member="main.c::nextDrivePattern" ref="a4" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__regvar __no_init volatile unsigned char <a class="el" href="main_8c.html#a4">nextDrivePattern</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
The power stage enable signals that will be output to the motor drivers at next commutation. 
<p>
This variable holds the pattern of enable signals that will be output to the power stage at next commutation. It is stored in register R13 for quick access.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00050">50</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00482">Commutate()</a>, <a class="el" href="main_8c-source.html#l00507">EnableZCDetection()</a>, and <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9"></a><!-- doxytag: member="main.c::referenceVoltageADC" ref="a9" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">volatile unsigned char <a class="el" href="main_8c.html#a9">referenceVoltageADC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
ADC reading of the known external reference voltage. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00074">74</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00719">CalculateCurrent()</a>, <a class="el" href="main_8c-source.html#l00211">InitADC()</a>, and <a class="el" href="main_8c-source.html#l00364">MotorPWMBottom()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8"></a><!-- doxytag: member="main.c::shuntVoltageADC" ref="a8" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">volatile unsigned char <a class="el" href="main_8c.html#a8">shuntVoltageADC</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
ADC reading of shunt voltage. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00071">71</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00719">CalculateCurrent()</a>, <a class="el" href="main_8c-source.html#l00544">CurrentMeasurementComplete()</a>, and <a class="el" href="main_8c-source.html#l00364">MotorPWMBottom()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7"></a><!-- doxytag: member="main.c::speedReferenceADC" ref="a7" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">volatile unsigned char <a class="el" href="main_8c.html#a7">speedReferenceADC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
ADC reading of external analog speed reference. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00068">68</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00707">CalculateSpeedSetpoint()</a>, <a class="el" href="main_8c-source.html#l00364">MotorPWMBottom()</a>, and <a class="el" href="main_8c-source.html#l00655">PWMControl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10"></a><!-- doxytag: member="main.c::speedUpdated" ref="a10" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">volatile unsigned char <a class="el" href="main_8c.html#a10">speedUpdated</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Flag that specifies whether a new external speed reference and a motor speed measurement is available. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00077">77</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00364">MotorPWMBottom()</a>, and <a class="el" href="main_8c-source.html#l00655">PWMControl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2"></a><!-- doxytag: member="main.c::startupDelays" ref="a2" args="[STARTUP_NUM_COMMUTATIONS]" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">unsigned int <a class="el" href="main_8c.html#a2">startupDelays</a>[STARTUP_NUM_COMMUTATIONS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Array holding the intercommutation delays used during startup. 
<p>

<p>
Definition at line <a class="el" href="main_8c-source.html#l00035">35</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00262">MakeTables()</a>, and <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5"></a><!-- doxytag: member="main.c::zcPolarity" ref="a5" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">__regvar __no_init volatile unsigned char <a class="el" href="main_8c.html#a5">zcPolarity</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Polarity of the expected zero crossing. 
<p>
The polarity of the expected zero crossing. Could be eiter <a class="el" href="BLDC_8h.html#a26">EDGE_FALLING</a> or <a class="el" href="BLDC_8h.html#a27">EDGE_RISING</a>.
<p>
Definition at line <a class="el" href="main_8c-source.html#l00057">57</a> of file <a class="el" href="main_8c-source.html">main.c</a>.
<p>
Referenced by <a class="el" href="main_8c-source.html#l00482">Commutate()</a>, <a class="el" href="main_8c-source.html#l00364">MotorPWMBottom()</a>, and <a class="el" href="main_8c-source.html#l00311">StartMotor()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Tue Oct 11 10:57:04 2005 for Sensorless control of 3-phase brushless DC motors by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
